#!/usr/bin/env bash

# Sail Manager - Switch between Laravel Sail and Spin Adapter
set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

VERSION="1.0.0"

REPO_OWNER="rodrigofs"
REPO_NAME="sail-spin-adapter"
REPO_BRANCH="main"

REPO_URL="https://github.com/rodrigofs/sail-spin-adapter"
RAW_URL="https://raw.githubusercontent.com/rodrigofs/sail-spin-adapter/main"
SAIL_ADAPTER_DIR="$HOME/.sail-spin-adapter"

# Detect shell profile file
get_shell_profile() {
    if [ -n "$ZSH_VERSION" ]; then
        echo "$HOME/.zshrc"
    elif [ -n "$BASH_VERSION" ]; then
        if [ -f "$HOME/.bashrc" ]; then
            echo "$HOME/.bashrc"
        else
            echo "$HOME/.bash_profile"
        fi
    else
        echo "$HOME/.profile"
    fi
}

# get remote commit hash
get_remote_commit() {
    curl -fsSL "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/commits?path=sail&sha=$REPO_BRANCH&per_page=1" \
        | grep -m1 '"sha"' \
        | sed -E 's/.*"sha": *"([^"]+)".*/\1/'
}

# get local commit hash
get_local_commit() {
    local commit_file="$SAIL_ADAPTER_DIR/sail-spin.commit"

    if [ -f "$commit_file" ]; then
        cat "$commit_file"
    else
        echo ""
    fi
}

# set local commit hash
set_local_commit() {
    local sha="$1"
    local commit_file="$SAIL_ADAPTER_DIR/sail-spin.commit"

    mkdir -p "$SAIL_ADAPTER_DIR"
    echo "$sha" > "$commit_file"
}


# Detect project type in current directory
detect_project_type() {
    # Check for Spin project indicators
    if [ -d "./.infrastructure" ]; then
        echo "spin"
        return
    fi
    
    # Check for Laravel Sail project indicators
    if [ -f "./docker-compose.yml" ] || [ -f "./compose.yml" ]; then
        if grep -q "laravel.test" docker-compose.yml 2>/dev/null || grep -q "laravel.test" compose.yml 2>/dev/null; then
            echo "sail"
            return
        fi
    fi
    
    # Check for Laravel project with vendor/bin/sail
    if [ -f "./vendor/bin/sail" ] || [ -f "./sail" ]; then
        echo "sail"
        return
    fi
    
    echo "unknown"
}

# Install the adapter
install_adapter() {
    echo -e "${GREEN}üöÄ Installing Sail to Spin Adapter...${NC}"
    
    # Create adapter directory
    mkdir -p "$SAIL_ADAPTER_DIR"
    
    # Download the adapter script
    echo -e "${YELLOW}Downloading adapter...${NC}"
    if curl -fsSL "$RAW_URL/sail" -o "$SAIL_ADAPTER_DIR/sail-spin"; then
        chmod +x "$SAIL_ADAPTER_DIR/sail-spin"
        echo -e "${GREEN}‚úì Adapter downloaded!${NC}"
    else
        echo -e "${RED}‚úó Download failed${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}‚úì Installation complete!${NC}"
    echo ""
    echo -e "${YELLOW}Next steps:${NC}"
    echo -e "  ${YELLOW}sail-manager activate${NC}   - Use Spin adapter"
    echo -e "  ${YELLOW}sail-manager deactivate${NC} - Use Laravel Sail"
    echo -e "  ${YELLOW}sail-manager status${NC}     - Check current mode"
}

# Detecta o arquivo de profile (mant√©m sua fun√ß√£o atual)
get_shell_profile() {
    if [ -n "$ZSH_VERSION" ]; then
        echo "$HOME/.zshrc"
    elif [ -n "$BASH_VERSION" ]; then
        if [ -f "$HOME/.bashrc" ]; then
            echo "$HOME/.bashrc"
        else
            echo "$HOME/.bash_profile"
        fi
    else
        echo "$HOME/.profile"
    fi
}

# Reload shell if interactive
maybe_reload_shell() {
    if [[ $- == *i* ]]; then
        echo "Reloading shell‚Ä¶"
        exec "$SHELL" -l
    else
        echo -e "${YELLOW}Reload your shell or run: source $profile_file${NC}"
    fi
}

# Activate Spin adapter
activate_spin() {
    local profile_file
    profile_file=$(get_shell_profile)

    echo -e "${YELLOW}Removing existing sail alias...${NC}"

    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' '/^alias sail=/d' "$profile_file"
        sed -i '' '/# Laravel Sail/d' "$profile_file"
        sed -i '' '/# Sail Spin Adapter/d' "$profile_file"
        sed -i '' "\|$SAIL_ADAPTER_DIR/sail-spin|d" "$profile_file"
    else
        sed -i '/^alias sail=/d' "$profile_file"
        sed -i '/# Laravel Sail/d' "$profile_file"
        sed -i '/# Sail Spin Adapter/d' "$profile_file"
        sed -i "\|$SAIL_ADAPTER_DIR/sail-spin|d" "$profile_file"
    fi

    trim_trailing_blank_lines "$profile_file"

    echo -e "${YELLOW}Activating Spin adapter...${NC}"

    {
        echo ""
        echo "# Sail Spin Adapter"
        echo "alias sail='$SAIL_ADAPTER_DIR/sail-spin'"
    } >> "$profile_file"

    if ! grep -q "alias sail-auto=" "$profile_file" 2>/dev/null; then
        echo "alias sail-auto='sail-manager auto'" >> "$profile_file"
    fi

    echo -e "${GREEN}‚úì Spin adapter activated!${NC}"

    maybe_reload_shell
}

# Remove trailing blank lines from a file
trim_trailing_blank_lines() {
    local file="$1"

    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS / BSD sed
        sed -i '' -e :a -e '/^[[:space:]]*$/{$d;N;ba' -e '}' "$file"
    else
        # GNU sed (Linux)
        sed -i -e :a -e '/^[[:space:]]*$/{$d;N;ba' -e '}' "$file"
    fi
}

# Deactivate adapter and restore Laravel Sail
deactivate_spin() {
    local profile_file
    profile_file=$(get_shell_profile)

    echo -e "${YELLOW}Restoring Laravel Sail...${NC}"

    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' '/^alias sail=/d' "$profile_file"
        sed -i '' '/# Sail Spin Adapter/d' "$profile_file"
        sed -i '' '/# Laravel Sail/d' "$profile_file"
        sed -i '' "\|$SAIL_ADAPTER_DIR/sail-spin|d" "$profile_file"
    else
        sed -i '/^alias sail=/d' "$profile_file"
        sed -i '/# Sail Spin Adapter/d' "$profile_file"
        sed -i '/# Laravel Sail/d' "$profile_file"
        sed -i "\|$SAIL_ADAPTER_DIR/sail-spin|d" "$profile_file"
    fi

    # üîπ Remove linhas em branco no final ANTES de anexar o bloco
    trim_trailing_blank_lines "$profile_file"

    {
        echo ""                       # exatamente UMA linha em branco
        echo "# Laravel Sail"
        echo "alias sail='sh \$([ -f sail ] && echo sail || echo vendor/bin/sail)'"
    } >> "$profile_file"

    if ! grep -q "alias sail-auto=" "$profile_file" 2>/dev/null; then
        echo "alias sail-auto='sail-manager auto'" >> "$profile_file"
    fi

    echo -e "${GREEN}‚úì Laravel Sail restored!${NC}"

    maybe_reload_shell
}

# Auto-detect and switch based on current project
auto_switch() {
    local project_type=$(detect_project_type)
    local current_dir=$(basename "$PWD")
    
    echo -e "${YELLOW}Auto-detecting project type in '$current_dir'...${NC}"
    
    case "$project_type" in
        "spin")
            echo -e "${GREEN}Spin project detected!${NC}"
            activate_spin
            ;;
        "sail")
            echo -e "${YELLOW}Laravel Sail project detected!${NC}"
            deactivate_spin
            ;;
        "unknown")
            echo -e "${RED}Unable to detect project type${NC}"
            echo "Looking for:"
            echo "  - Spin: docker-compose.spin.yml, .spin/, spin.yml"
            echo "  - Laravel Sail: vendor/bin/sail, sail, laravel.test in docker-compose"
            echo ""
            echo "Use manual commands:"
            echo "  sail-manager activate   # For Spin projects"
            echo "  sail-manager deactivate # For Laravel Sail projects"
            ;;
    esac
}

# Check current status
check_status() {
    local profile_file=$(get_shell_profile)
    local project_type=$(detect_project_type)
    local current_dir=$(basename "$PWD")
    
    echo "Sail Manager Status:"
    echo "==================="
    echo -e "${YELLOW}Current directory: $current_dir${NC}"
    echo -e "${YELLOW}Detected project type: $project_type${NC}"
    echo ""
    
    if grep -q "alias sail='$SAIL_ADAPTER_DIR/sail-spin'" "$profile_file" 2>/dev/null; then
        echo -e "${GREEN}Current mode: Spin Adapter${NC}"
        if [ "$project_type" = "sail" ]; then
            echo -e "${RED}‚ö†Ô∏è  Warning: You're in a Laravel Sail project but using Spin adapter${NC}"
            echo -e "   Consider running: sail-manager auto"
        fi
    elif grep -q "alias sail=" "$profile_file" 2>/dev/null; then
        echo -e "${YELLOW}Current mode: Laravel Sail${NC}"
        if [ "$project_type" = "spin" ]; then
            echo -e "${RED}‚ö†Ô∏è  Warning: You're in a Spin project but using Laravel Sail${NC}"
            echo -e "   Consider running: sail-manager auto"
        fi
    else
        echo -e "${RED}No sail alias configured${NC}"
    fi
    
    echo ""
    echo "Available commands:"
    echo "  sail-manager auto        - Auto-detect and switch"
    echo "  sail-manager activate    - Force Spin adapter"
    echo "  sail-manager deactivate  - Force Laravel Sail"
}

# Update adapter
update_adapter() {
    local silent="no"
    if [ "${1:-}" = "--silent" ]; then
        silent="yes"
    fi

    [ "$silent" = "no" ] && echo -e "${YELLOW}Checking for adapter updates (by commit)...${NC}"

    mkdir -p "$SAIL_ADAPTER_DIR"

    local current="$SAIL_ADAPTER_DIR/sail-spin"
    local tmp="$SAIL_ADAPTER_DIR/sail-spin.tmp"

    local remote_sha
    remote_sha=$(get_remote_commit)

    if [ -z "$remote_sha" ]; then
        [ "$silent" = "no" ] && echo -e "${RED}‚úó Could not get remote commit from GitHub API${NC}"
        return 1
    fi

    local local_sha
    local_sha=$(get_local_commit)

    if [ -n "$local_sha" ] && [ "$local_sha" = "$remote_sha" ] && [ -f "$current" ]; then
        [ "$silent" = "no" ] && echo -e "${GREEN}‚úì Adapter already up to date (commit $remote_sha).${NC}"
        return 0
    fi

    [ "$silent" = "no" ] && echo -e "${YELLOW}New commit detected (local: ${local_sha:-none}, remote: $remote_sha). Downloading...${NC}"

    if ! curl -fsSL "$RAW_URL/sail" -o "$tmp"; then
        [ "$silent" = "no" ] && echo -e "${RED}‚úó Failed to download latest adapter script${NC}"
        rm -f "$tmp"
        return 1
    fi

    mv "$tmp" "$current"
    chmod +x "$current"
    set_local_commit "$remote_sha"

    [ "$silent" = "no" ] && echo -e "${GREEN}‚úì Adapter updated to commit $remote_sha.${NC}"

    return 0
}

maybe_auto_update() {
    local command="$1"

    case "$command" in
        update|install|help|-h|--help|--version|star)
            return
            ;;
    esac

    mkdir -p "$SAIL_ADAPTER_DIR"

    local ts_file="$SAIL_ADAPTER_DIR/last_update_check"
    local now last interval

    interval=$((24 * 60 * 60))

    if [ -n "$SAIL_MANAGER_UPDATE_INTERVAL" ]; then
        interval="$SAIL_MANAGER_UPDATE_INTERVAL"
    fi

    now=$(date +%s)

    if [ -f "$ts_file" ]; then
        last=$(cat "$ts_file" 2>/dev/null || echo 0)

        if [ "$((now - last))" -lt "$interval" ]; then
            return
        fi
    fi

    update_adapter --silent || true

    echo "$now" > "$ts_file"
}

# Open repository
star_repo() {
    echo -e "${YELLOW}‚≠ê Repository: $REPO_URL${NC}"
    if command -v xdg-open &> /dev/null; then
        xdg-open "$REPO_URL"
    elif command -v open &> /dev/null; then
        open "$REPO_URL"
    else
        echo "Open: $REPO_URL"
    fi
}

# Show help
show_help() {
    echo "Sail Manager v$VERSION"
    echo ""
    echo "Commands:"
    echo "  auto         Auto-detect project type and switch (RECOMMENDED)"
    echo "  install      Install the Spin adapter"
    echo "  activate     Force use Spin adapter"
    echo "  deactivate   Force use Laravel Sail"
    echo "  status       Check current configuration and project type"
    echo "  update       Update the adapter"
    echo "  star         ‚≠ê Give star to the project"
    echo "  help         Show this help"
    echo ""
    echo "Workflow:"
    echo "  1. cd /path/to/spin-project && sail-manager auto"
    echo "  2. cd /path/to/laravel-project && sail-manager auto"
    echo "  3. The 'sail' command will work correctly in each project!"
    echo ""
    echo "The manager works by switching the 'sail' alias in your shell profile."
}

# Main function
main() {
    maybe_auto_update "$cmd"

    case "${1:-help}" in
        "auto") auto_switch ;;
        "install") install_adapter ;;
        "activate") activate_spin ;;
        "deactivate") deactivate_spin ;;
        "status") check_status ;;
        "update") update_adapter ;;
        "star") star_repo ;;
        "help"|"-h"|"--help") show_help ;;
        "--version") echo "v$VERSION" ;;
        *)
            echo -e "${RED}Invalid command: $1${NC}"
            echo "Use: sail-manager help"
            exit 1
            ;;
    esac
}

main "$@"